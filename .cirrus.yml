task:
  # Use the maximum timeout. Needed when rebuilding packages on a channel update.
  timeout_in: 120m

  macos_instance:
    image: ghcr.io/cirruslabs/macos-monterey-base:latest

  matrix:
    - name: build
      environment:
        GIT_CRYPT_TOKEN: ENCRYPTED[415884b4c6e8e899e8808b433a8fc0c153f095c6fef7db2963b7ab0110bd53b9d79e5d37a7543987f34290c7c8c70686]
        PRAGMATAPRO_SSH_KEY: ENCRYPTED[c1d1c03146c8dfdd70f6a982cf45bef1ecc468d7af6525048bdde512516e809b8ee9b520f31dfc73a3d4244cfcfa5355]
        CIRRUS_USER_PERMISSION: admin
      install_script:
        - sh <(curl -L https://nixos.org/nix/install)
        - mkdir -p $HOME/.config/nix
        - echo "extra-experimental-features = nix-command flakes" >> $HOME/.config/nix/nix.conf
        - echo "$(whoami)"
        - echo "trusted-users = $(whoami)" >> $HOME/.config/nix/nix.conf
        # - |
        #   mkdir -p $HOME/.local/share/nix
        #   echo "
        #     {
        #       \"extra-experimental-features\": {
        #         \"nix-command flakes\": true,
        #         \"nix-command flakes ca-references\": true
        #       },
        #       \"extra-substituters\": {
        #         \"https://cachix.org/api/v1/cache/tilde https://nrdxp.cachix.org https://nix-community.cachix.org\": true
        #       },
        #       \"extra-trusted-public-keys\": {
        #         \"tilde.cachix.org-1:vjup2ixrsWKk+v8FXCqusKWBRwU0l7EzumjnMV4n2Vg= nrdxp.cachix.org-1:Fc5PSqY2Jm1TrWfm88l6cvGWwz3s93c6IOifQWnhNW4= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=\": true
        #       },
        #       \"trusted-substituters\": {
        #         \"https://cachix.org/api/v1/cache/tilde https://nrdxp.cachix.org https://nix-community.cachix.org\": true
        #       }
        #     }
        #   " >> $HOME/.local/share/nix/trusted-settings.json
      build_script:
        - echo "$PRAGMATAPRO_SSH_KEY" > /tmp/pragmatapro-key
        - ssh-add -K /tmp/pragmatapro-key
        - echo "$GIT_CRYPT_TOKEN" | base64 -d > /tmp/git-crypt-key.asc
        - /nix/var/nix/profiles/default/bin/nix develop -c "git-crypt" "unlock" "/tmp/git-crypt-key.asc"
        # - /nix/var/nix/profiles/default/bin/nix develop --extra-experimental-features nix-command --extra-experimental-features flakes --show-trace -c "git-crypt" "unlock" "/tmp/git-crypt-key.asc"
        # - /nix/var/nix/profiles/default/bin/nix flake check --extra-experimental-features nix-command --extra-experimental-features flakes --show-trace
        # - /nix/var/nix/profiles/default/bin/nix build .#darwinConfigurations.st-eturkeltaub2.system --extra-experimental-features nix-command --extra-experimental-features flakes --show-trace
