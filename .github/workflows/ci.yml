jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: "actions/checkout@v2.4.0"
      - name: Install Nix
        uses: "cachix/install-nix-action@v16"
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Add SSH key to ssh-agent
        uses: "webfactory/ssh-agent@v0.5.4"
        with:
          ssh-private-key: "${{ secrets.PRAGMATAPRO_DEPLOY_KEY }}"
      - env:
          GPG_KEY_GRIP: "${{ secrets.GPG_KEY_GRIP }}"
          GPG_KEY_PASS: ''
          GPG_PRIVATE_KEY: "${{ secrets.GPG_PRIVATE_KEY }}"
        name: Unlock with git-crypt
        uses: "zemuldo/git-crypt-unlock@v2.0"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: tilde
      - run: |
          nix-shell -p git-crypt --command "nix -Lv build .#darwinConfigurations.${{ matrix.host }}.system --show-trace"
    strategy:
      matrix:
        host:
          - eMac
          - st-eturkeltaub1
  check:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: "actions/checkout@v2.4.0"
      - name: Install Nix
        uses: "cachix/install-nix-action@v16"
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Add SSH key to ssh-agent
        uses: "webfactory/ssh-agent@v0.5.4"
        with:
          ssh-private-key: "${{ secrets.PRAGMATAPRO_DEPLOY_KEY }}"
      - env:
          GPG_KEY_GRIP: "${{ secrets.GPG_KEY_GRIP }}"
          GPG_KEY_PASS: ''
          GPG_PRIVATE_KEY: "${{ secrets.GPG_PRIVATE_KEY }}"
        name: Unlock with git-crypt
        uses: "zemuldo/git-crypt-unlock@v2.0"
      - uses: "cachix/cachix-action@v10"
        with:
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          name: tilde
      - run: |
          echo "${{ secrets.GIT_CRYPT_KEY }}" | base64 -d > /tmp/git-crypt-key
          nix-shell -p git-crypt --command "git-crypt unlock /tmp/git-crypt-key"
          nix flake -Lv check --show-trace
name: CI
on:
  push: {}
